# ТЕХНИЧЕСКОЕ ЗАДАНИЕ  
## Восстановление FDM-детали для прочностного анализа и геометрической реконструкции  
### Проект: slice2solid

---

## 1. Назначение и цель проекта

Целью проекта является создание универсального программного инструмента
для восстановления цифрового представления детали,
изготовленной методом FDM (Fused Deposition Modeling),
на основе данных слайсинга (Stratasys Insight),
с последующим использованием результатов:

- для конечно-элементного анализа (CAE),
- для восстановления геометрии детали с внутренней структурой (инфиллом),
- для применения детали в сборках и дальнейших инженерных расчетах.

Проект ориентирован на инженерный уровень точности и предназначен
для применения в системах конечно-элементного анализа, таких как ANSYS.

---

## 2. Общая концепция решения

Проект реализует **двухрежимный подход** к использованию данных слайсинга:

1. **CAE-режим (основной)**  
   Используется для прочностного анализа.
   Геометрия детали является гладкой и замкнутой,
   а внутренняя структура печати учитывается через
   анизотропные свойства материала и ориентацию траекторий.

2. **Геометрический режим (опциональный, после CAE)**  
   Используется для восстановления явной геометрии внутренней структуры
   (инфилл, периметры) после подтверждения результатов расчета.
   Предназначен для использования детали в сборках,
   оценки массы, инерции и визуализации.

Оба режима используют **одни и те же данные слайсинга**,
но применяют их для разных инженерных целей.

---

## 3. Описание технологической цепочки

### 3.1 CAD-этап
1. В САПР проектируется монолитное твердое тело.
2. Геометрия экспортируется в STL-файл в системе координат САПР.

### 3.2 Этап слайсинга (Stratasys Insight)
1. STL-файл импортируется в Stratasys Insight.
2. Деталь ориентируется и размещается на рабочем столе.
3. Ориентированная деталь сохраняется в виде нового STL-файла (placed STL).
4. Задаются параметры печати (включая процент и паттерн инфилла).
5. Выполняется слайсинг.
6. Экспортируются данные симуляции траекторий печати.

### 3.3 Пайплайн slice2solid (GUI-режим)

Ниже описан пайплайн, который выполняется при запуске через графический интерфейс (GUI) и формирует выходные файлы для CAD/CAE-инструментов (в т.ч. ANSYS).

**Вход (что выбирает пользователь в GUI):**
1. `*-simulation-data.txt` — экспорт симуляции траекторий из Insight.
2. (Опционально) папка задания `ssys_*` — для авто-параметров (ширина дорожки, пороги фильтрации).
3. `placed STL (*.stl)` — эталонная геометрия для габаритов/сопоставления координат.
4. Папка результата — куда будут записаны выходные файлы.

**Шаги пайплайна:**
1. **Разбор Simulation Data**
   - читается заголовок (slice height, shrink factors, матрица `STL -> CMB` и др.),
   - валидируются преобразования координат (точки после `CMB -> placed STL` должны попадать в габариты placed STL с допуском).
2. **Преобразование координат траекторий**
   - применяется обратная матрица `CMB -> STL` (см. раздел 5) для перевода всех точек в систему координат placed STL.
3. **Фильтрация траекторий**
   - используются только траектории модели (`Type = 1`),
   - “прыжки” между разорванными цепочками (travel/jump) могут игнорироваться по порогу `max_jump_mm`, чтобы не “заливать” материал по воздуху.
4. **Вокселизация материала по траекториям**
   - по сегментам траектории строится 3D-решетка занятых вокселей (voxel size в мм),
   - применяется (опционально) удаление малых компонент шума по порогу `min_component_voxels`.
5. **Построение поверхности (mesh)**
   - из 3D-объёма строится треугольная сетка (marching cubes),
   - (опционально) сглаживание объёма `sigma` перед meshing,
   - (опционально) удаление мелких “островков” сетки по порогу `min_mesh_component_faces`,
   - (опционально) лёгкое сглаживание сетки (Laplacian iterations) для приятной поверхности.
6. **Экспорт выходных файлов**
   - всегда пишутся метаданные (`metadata.json`),
   - при включённом “Геометрия” экспортируется STL (и опционально CAD bundle: PLY + point cloud + заметки по импорту),
   - при включённом “ANSYS / CAE” экспортируются таблицы ориентаций слоёв и скрипт импорта в Mechanical.
7. **(Опционально) Mesh Healer (CAD)**
   - если включён `Mesh Healer (CAD)`, после экспорта STL выполняется “лечение” сетки в профиле `safe` или `aggressive`,
   - результат сохраняется как `*_healed.stl` рядом с исходным STL,
   - (опционально) пишется JSON-отчёт до/после.

**Основные выходные файлы (в папке результата):**
- `*_s2s_preview_structure.stl` - сетка "после" (результат пайплайна, пригодна для импорта как mesh и для Mesh Healer).
- `*_s2s_preview_structure_healed.stl` - (опционально) исправленная сетка для импорта в CAD как mesh.
- `*_s2s_preview_structure_healed_report.json` - (опционально) отчёт до/после по сетке.
- `*_s2s_preview_structure_mesh.ply` + `voxel_points.csv` + `cad_import_notes.txt` - (опционально) CAD bundle для внешних CAD/mesh-инструментов.
- `ansys_layers.json`, `ansys_layers.csv` — таблица слоёв/направлений укладки (для CAE).
- `ansys_mechanical_import_layers.py` — путь A (legacy): попытка создать Named Selections/Coordinate Systems через Mechanical Scripting API.
- `ansys_mapdl_layers.mac` — путь B (рекомендуется): MAPDL snippet для разбиения элементов по слоям (CM) и назначения ESYS по углу укладки.
- `ansys_mapdl_layers_report.txt` — отчёт, создаваемый MAPDL snippet при решении (сколько элементов попало в каждый слой/группу).
- `insight_part.sgm` — (опционально) извлечённый slice/group файл Insight для диагностики (из `*.sgm.gz` или архива в `ssys_*`).
- `metadata.json` - метаданные запуска (параметры, матрица, оценки размеров/сеток и т.п.).

---

## 4. Входные данные проекта

### 4.1 Геометрические данные
- Исходный STL-файл (из САПР)
- STL-файл после размещения в слайсере (placed STL)

Placed STL является **эталонной геометрией** для всех последующих этапов.

### 4.2 Данные траекторий печати (основной источник)
Текстовый файл экспорта данных симуляции, содержащий:
- координаты X, Y, Z,
- временные метки,
- площадь сечения валика,
- тип траектории,
- режим печати (bead mode).

Эти данные являются **основным источником информации** о:
- внутренней структуре детали,
- направлениях печати,
- слоевой организации.

### 4.3 Дополнительные файлы слайсера
Файлы, содержащие:
- параметры слайсинга,
- коэффициенты усадки,
- матрицы преобразования координат,
- сведения о режимах печати.

Используются для уточнения интерпретации данных траекторий.

---

### 4.4 Артефакты задания Stratasys Insight (папки `ssys_*`)

В Stratasys Insight результаты слайсинга обычно сохраняются в папку задания (например, `ssys_part`, `ssys_part-table`, `ssys_g-part`),
в которой могут находиться:

- `*.sjb` — текстовое описание задания (пути к STL, имя задания, имя `*.cmb`).
- `*.cmb` — бинарный контейнер траекторий (toolpath) для машины.
- `*.sgm.gz` — сжатый текст со структурой слоёв/групп (например группы Base/Part/Support).
- `*.sbs` — скрипт build style (материал, сопла, высота слоя и прочие настройки).
- `sliceParams.*`, `toolpathParams.*`, `supportParams.*` (`.cur` / `.new`) — “снимки” параметров в виде Tcl `setVersionVar ...`.
- `log.txt`, `graphics.log`, `*.bmp` — логи/диагностика/превью.

Эти файлы рассматриваются как **вторичные метаданные**. Основной вход проекта — текстовый экспорт симуляции траекторий.

---

### 4.5 Проверенные правила классификации (экспорт Simulation Data)

По результатам нескольких экспериментальных экспортов таблица `Toolpath Simulation Data` в файле симуляции интерпретируется так:

- `Type = 1` — траектории модели (детали).
- `Type = 0` — траектории поддержек/подложки (включая base/raft и supports в объёме, если они есть).

Чтобы отделить подложку (base/raft) от поддержек в объёме:

1. Вычислить `z_model_min = min(Z)` по строкам, где `Type = 1`.
2. **Подложка / base / raft**: строки, где `Type = 0` и `Z < z_model_min`.
3. **Поддержки (не подложка)**: строки, где `Type = 0` и `Z >= z_model_min`.

Значения `BeadMode` для траекторий модели (`Type = 1`) **зависят от настроек** (паттерн инфилла, количество контуров и т.д.),
поэтому их нельзя жёстко "прибивать" к фиксированным смыслам без учёта параметров.

---

### 4.6 Заголовок Simulation Data: метаданные и проверки

В файле экспорта симуляции (например `*-simulation-data.txt`) перед таблицей содержится блок `Toolpath Simulation Data`
со строками вида `Key : Value` и секция `STL to CMB transformation matrix`.
Эти данные используются для автоконфигурации, валидации и формирования отчёта.

**Нормативные поля (используются алгоритмами/проверками):**
- `Slice height` (мм) — шаг слоя для разбиения траекторий по слоям.
- `Segment filter length` (мм) — характерная длина сегментации; используется как ориентир для фильтрации “прыжков”.
- `STL to CMB transformation matrix` — преобразование координат таблицы (CMB) в систему placed STL.
- `Model *-shrink` / `Support *-shrink` — коэффициенты усадки по осям; используются для диагностики и проверки матрицы.

**Информативные поля (для отчёта/пресетов):**
- `Version`, `Insight version`, `Modeler type`, `Build mode`, `STL units`, материалы/сопла.

**Проверки корректности:**
- матрица должна быть 4×4, с конечными числами, `M[3,3] ≈ 1`;
- конвенция Insight: точки трактуются как *row-vector*, перенос находится в последней строке матрицы (если перенос в последнем столбце — это повод для предупреждения);
- если матрица близка к диагональной — её масштабы должны быть согласованы с `Model *-shrink` (в пределах допусков);
- после преобразования `CMB -> placed STL` точки траекторий должны попадать в габариты placed STL (с допуском).

**Smart travel/jump:**
- сегменты с `Factor <= 0` или `Bead Area <= 0` считаются перемещениями без наплавления (travel): такие отрезки не учитываются при расчёте ориентации и не “заливают” воксели;
- порог `max_jump` (если нужен) выбирается на основе `Segment filter length`, оценок ширины валика и статистики длин сегментов (устойчивые к выбросам оценки, например медиана/квантили).

**Надёжность парсинга:**
- необходимо учитывать локали: в некоторых экспортных файлах десятичный разделитель может быть запятой.

---

## 5. Системы координат и преобразования

В проекте используются следующие системы координат:
1. Система координат САПР
2. Система координат слайсера / рабочего стола
3. Система координат CAE

Все данные траекторий приводятся к системе координат placed STL
с учетом матриц преобразования и коэффициентов усадки,
предоставляемых слайсером.

---

### 5.1 Конвенция преобразований (экспорт Simulation Data)

Файл экспорта симуляции содержит:

- коэффициенты усадки по осям (для model/support),
- матрицу `STL to CMB transformation matrix`,
- таблицу точек/сегментов траекторий в координатах **CMB**.

В проекте эталонной системой координат считается placed STL. Поэтому при сопоставлении траекторий с геометрией:

- `XYZ` из таблицы читаются как CMB-координаты,
- применяется обратное преобразование (`CMB -> STL`) на основе матрицы `STL -> CMB` (и коэффициентов усадки, как они указаны слайсером).

Реализация должна валидировать преобразование: преобразованные точки траекторий должны попадать в габариты (или вблизи) placed STL.


## 6. CAE-представление детали (основной режим)

### 6.1 Геометрия
- Гладкое, замкнутое твердое тело,
- соответствующее placed STL,
- без явного моделирования инфилла, поддержек и подложки.

### 6.2 Сетка
- Объемная конечно-элементная сетка (tet/hex),
- плотность сетки не привязана к геометрии валиков.

---

## 7. Материальная модель

Материал детали моделируется как **трансверсально-изотропный**:

- плоскость изотропии: плоскость печати (XY),
- ось анизотропии: направление построения (Z).

Параметры материала:
- E₁ = E₂ ≠ E₃
- G₁₂, G₁₃, G₂₃
- ν₁₂, ν₁₃, ν₂₃

---

## 8. Учет внутренней структуры печати (инфилла)

Внутренняя структура заполнения, сформированная в слайсере
(процент инфилла, паттерн, ориентация дорожек),
**не восстанавливается в виде явной геометрической решетки**
в CAE-режиме.

Влияние инфилла учитывается через:
- ориентацию траекторий печати,
- локальные системы координат материала,
- эффективные анизотропные свойства элементов.

Таким образом, гладкая геометрия используется как расчетная область,
а внутренняя структура отражается в физических свойствах материала.

---

## 9. Сопоставление траекторий и конечных элементов

Каждому конечному элементу назначается локальная система координат:

- ось X — вдоль доминирующего направления траектории печати,
- ось Z — вдоль направления построения,
- ось Y — ортогональное дополнение.

Ориентация определяется на основе анализа траекторий
в соответствующем слое по координате Z.

---

## 10. Поддержки и подложка

- Поддержки и подложка (raft) идентифицируются по типу траектории
  и/или по координате Z.
- Эти элементы **исключаются** из расчетной геометрии детали.
- Их данные могут использоваться только для диагностики.

---

## 11. Геометрическое восстановление внутренней структуры (опциональный режим)

После выполнения CAE-анализа и подтверждения корректности результатов
проект предусматривает возможность восстановления
явной геометрической модели внутренней структуры детали.

Геометрическая реконструкция может выполняться в виде:
- протягивания (sweep) валиков по траекториям печати,
- воксельного восстановления с последующей генерацией твердого тела,
- гибридного подхода с гладкой внешней оболочкой и внутренним инфиллом.

Данный режим предназначен для:
- использования детали в сборках,
- оценки массы и моментов инерции,
- визуализации и архивирования.

---

### 11.1 Конвертация результата в CAD-твердое тело (STEP) во внешних инструментах

Прямое преобразование пористой/воксельной структуры в корректное B-Rep твердое тело (STEP) часто получается тяжёлым и нестабильным, особенно при наличии мелких внутренних элементов (инфилла).
Поэтому конвертацию в “настоящее” CAD-тело следует рассматривать как **задачу внешнего CAD/mesh-инструмента**, а задача slice2solid — подготовить максимально корректные и универсальные данные.

Рекомендуемый практический workflow (общий, без привязки к конкретному ПО):
1. Импортировать `*_s2s_preview_structure.stl` (или `.ply`) в единицах `mm`.
2. При необходимости выполнить ремонт сетки (Repair/Close Holes/Orient Normals, удаление self-intersections/мусора).
3. Если инструмент поддерживает: преобразовать mesh/implicit/volume в твердое тело (B-Rep).
4. Экспортировать результат в `STEP` (или другой CAD-формат).

Соответственно, проект должен формировать универсальные файлы для этой стадии:
- `*_s2s_preview_structure.stl` (основной) — mesh результата,
- `*_s2s_preview_structure_mesh.ply` (опционально) — альтернативный формат mesh,
- `voxel_points.csv` (опционально) — point cloud из занятых вокселей (x,y,z; может быть sampled),
- `cad_import_notes.txt` (опционально) — заметки по импорту и стартовым параметрам spacing/resolution,
- `metadata.json` — метаданные (размер вокселя, пороги, исходные файлы/задание, shrink/матрица, правила фильтрации траекторий).

---

### 11.2 Mesh Healer (CAD mesh) (доп. этап после экспорта сетки)

Для импорта в CAD как **mesh-body** (объект на основе сетки) сетка должна быть по возможности:
- замкнутой (watertight),
- с корректной ориентацией граней/нормалей,
- без типовых дефектов (дубликаты вершин/граней, нулевые грани, “мусорные” вершины).

Проект должен предоставлять **опциональный** этап автоматического “лечения” сетки, который применяется **после** формирования финального STL/OBJ/PLY и **не меняет** логику генерации геометрии. По умолчанию используется профиль `safe`, без ремешинга/упрощения, чтобы не разрушить тонкие элементы инфилла.

**Профиль `safe` (без ремешинга/упрощения):**
- удаление дубликатов вершин/граней,
- удаление неиспользуемых вершин,
- удаление нулевых граней (нулевая площадь),
- переориентация граней (coherent),
- закрытие небольших отверстий с ограничением `--close-holes-max` (мм).

**Профиль `aggressive` (только по явному выбору):**
- дополнительно пытается удалить самопересекающиеся грани,
- допускает более “жёсткое” закрытие отверстий (через увеличенный порог).

**Примечание по порогу отверстий:** в MeshLab/pymeshlab параметр закрытия отверстий обычно задаётся как ограничение **по числу рёбер контура** (а не напрямую в мм). Поэтому `--close-holes-max` (мм) интерпретируется как “примерный диаметр отверстия” и переводится в рёбра по оценке средней длины граничных рёбер; это отражается в JSON-отчёте.

**Интеграция с пользовательским интерфейсом (GUI):**
- Вкладка `CAD / Геометрия` содержит блок `Mesh Healer (CAD)`:
  - “включить” (создаёт `*_healed.stl` рядом с исходным STL),
  - выбор профиля `safe/aggressive`,
  - порог `close_holes_max` (мм),
  - опциональный JSON-отчёт `*_healed_report.json` (до/после).

**CLI (standalone):**
- `python run_cli.py heal input.stl --heal-preset safe --close-holes-max 2.0 --report heal_report.json`

**Backend:**
- основной: `pymeshlab` (предпочтительно),
- fallback: `meshlabserver` (через генерируемый `.mlx`, пример: `tools/meshlab/heal_safe_template.mlx`).

---

## 12. Выходные данные

Результаты работы проекта:
- CAE-пригодная геометрия (STL / STEP),
- данные ориентации материала для ANSYS,
- геометрия детали с внутренней структурой (опционально),
 - диагностические и статистические отчеты,
 - (опционально) “леченная” сетка `*_healed.stl` + JSON-отчёт до/после (`*_healed_report.json`).

---

## 13. Этапы реализации

### Этап 1 — Анализ данных слайсинга
- разбор форматов файлов,
- валидация координат,
- классификация траекторий.

### Этап 2 — CAE-представление
- формирование гладкой геометрии,
- задание анизотропии и ориентаций,
- экспорт в CAE.

### Этап 3 — Геометрическая реконструкция
- восстановление инфилла,
- формирование твердого тела,
- экспорт для CAD/сборок.

---

## 14. Допущения и ограничения

- пористость учитывается через эффективные свойства,
- термические остаточные напряжения не моделируются,
- материал внутри локальных областей считается однородным.

---

## 15. Возможные расширения

- межслойные когезионные модели,
- прогрессирующее разрушение,
- учет остаточных напряжений,
- многоматериальная печать.
