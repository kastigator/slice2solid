# ТЕХНИЧЕСКОЕ ЗАДАНИЕ  
## Восстановление FDM-детали для прочностного анализа и геометрической реконструкции  
### Проект: slice2solid

---

## 1. Назначение и цель проекта

Целью проекта является создание универсального программного инструмента
для восстановления цифрового представления детали,
изготовленной методом FDM (Fused Deposition Modeling),
на основе данных слайсинга (Stratasys Insight),
с последующим использованием результатов:

- для конечно-элементного анализа (CAE),
- для восстановления геометрии детали с внутренней структурой (инфиллом),
- для применения детали в сборках и дальнейших инженерных расчетах.

Проект ориентирован на инженерный уровень точности и предназначен
для применения в системах конечно-элементного анализа, таких как ANSYS.

---

## 2. Общая концепция решения

Проект реализует **двухрежимный подход** к использованию данных слайсинга:

1. **CAE-режим (основной)**  
   Используется для прочностного анализа.
   Геометрия детали является гладкой и замкнутой,
   а внутренняя структура печати учитывается через
   анизотропные свойства материала и ориентацию траекторий.

2. **Геометрический режим (опциональный, после CAE)**  
   Используется для восстановления явной геометрии внутренней структуры
   (инфилл, периметры) после подтверждения результатов расчета.
   Предназначен для использования детали в сборках,
   оценки массы, инерции и визуализации.

Оба режима используют **одни и те же данные слайсинга**,
но применяют их для разных инженерных целей.

---

## 3. Описание технологической цепочки

### 3.1 CAD-этап
1. В САПР проектируется монолитное твердое тело.
2. Геометрия экспортируется в STL-файл в системе координат САПР.

### 3.2 Этап слайсинга (Stratasys Insight)
1. STL-файл импортируется в Stratasys Insight.
2. Деталь ориентируется и размещается на рабочем столе.
3. Ориентированная деталь сохраняется в виде нового STL-файла (placed STL).
4. Задаются параметры печати (включая процент и паттерн инфилла).
5. Выполняется слайсинг.
6. Экспортируются данные симуляции траекторий печати.

---

## 4. Входные данные проекта

### 4.1 Геометрические данные
- Исходный STL-файл (из САПР)
- STL-файл после размещения в слайсере (placed STL)

Placed STL является **эталонной геометрией** для всех последующих этапов.

### 4.2 Данные траекторий печати (основной источник)
Текстовый файл экспорта данных симуляции, содержащий:
- координаты X, Y, Z,
- временные метки,
- площадь сечения валика,
- тип траектории,
- режим печати (bead mode).

Эти данные являются **основным источником информации** о:
- внутренней структуре детали,
- направлениях печати,
- слоевой организации.

### 4.3 Дополнительные файлы слайсера
Файлы, содержащие:
- параметры слайсинга,
- коэффициенты усадки,
- матрицы преобразования координат,
- сведения о режимах печати.

Используются для уточнения интерпретации данных траекторий.

---

### 4.4 Артефакты задания Stratasys Insight (папки `ssys_*`)

В Stratasys Insight результаты слайсинга обычно сохраняются в папку задания (например, `ssys_part`, `ssys_part-table`, `ssys_g-part`),
в которой могут находиться:

- `*.sjb` — текстовое описание задания (пути к STL, имя задания, имя `*.cmb`).
- `*.cmb` — бинарный контейнер траекторий (toolpath) для машины.
- `*.sgm.gz` — сжатый текст со структурой слоёв/групп (например группы Base/Part/Support).
- `*.sbs` — скрипт build style (материал, сопла, высота слоя и прочие настройки).
- `sliceParams.*`, `toolpathParams.*`, `supportParams.*` (`.cur` / `.new`) — “снимки” параметров в виде Tcl `setVersionVar ...`.
- `log.txt`, `graphics.log`, `*.bmp` — логи/диагностика/превью.

Эти файлы рассматриваются как **вторичные метаданные**. Основной вход проекта — текстовый экспорт симуляции траекторий.

---

### 4.5 Проверенные правила классификации (экспорт Simulation Data)

По результатам нескольких экспериментальных экспортов таблица `Toolpath Simulation Data` в файле симуляции интерпретируется так:

- `Type = 1` — траектории модели (детали).
- `Type = 0` — траектории поддержек/подложки (включая base/raft и supports в объёме, если они есть).

Чтобы отделить подложку (base/raft) от поддержек в объёме:

1. Вычислить `z_model_min = min(Z)` по строкам, где `Type = 1`.
2. **Подложка / base / raft**: строки, где `Type = 0` и `Z < z_model_min`.
3. **Поддержки (не подложка)**: строки, где `Type = 0` и `Z >= z_model_min`.

Значения `BeadMode` для траекторий модели (`Type = 1`) **зависят от настроек** (паттерн инфилла, количество контуров и т.д.),
поэтому их нельзя жёстко "прибивать" к фиксированным смыслам без учёта параметров.

---

### 4.6 Заголовок Simulation Data: метаданные и проверки

В файле экспорта симуляции (например `*-simulation-data.txt`) перед таблицей содержится блок `Toolpath Simulation Data`
со строками вида `Key : Value` и секция `STL to CMB transformation matrix`.
Эти данные используются для автоконфигурации, валидации и формирования отчёта.

**Нормативные поля (используются алгоритмами/проверками):**
- `Slice height` (мм) — шаг слоя для разбиения траекторий по слоям.
- `Segment filter length` (мм) — характерная длина сегментации; используется как ориентир для фильтрации “прыжков”.
- `STL to CMB transformation matrix` — преобразование координат таблицы (CMB) в систему placed STL.
- `Model *-shrink` / `Support *-shrink` — коэффициенты усадки по осям; используются для диагностики и проверки матрицы.

**Информативные поля (для отчёта/пресетов):**
- `Version`, `Insight version`, `Modeler type`, `Build mode`, `STL units`, материалы/сопла.

**Проверки корректности:**
- матрица должна быть 4×4, с конечными числами, `M[3,3] ≈ 1`;
- конвенция Insight: точки трактуются как *row-vector*, перенос находится в последней строке матрицы (если перенос в последнем столбце — это повод для предупреждения);
- если матрица близка к диагональной — её масштабы должны быть согласованы с `Model *-shrink` (в пределах допусков);
- после преобразования `CMB -> placed STL` точки траекторий должны попадать в габариты placed STL (с допуском).

**Smart travel/jump:**
- сегменты с `Factor <= 0` или `Bead Area <= 0` считаются перемещениями без наплавления (travel): такие отрезки не учитываются при расчёте ориентации и не “заливают” воксели;
- порог `max_jump` (если нужен) выбирается на основе `Segment filter length`, оценок ширины валика и статистики длин сегментов (устойчивые к выбросам оценки, например медиана/квантили).

**Надёжность парсинга:**
- необходимо учитывать локали: в некоторых экспортных файлах десятичный разделитель может быть запятой.

---

## 5. Системы координат и преобразования

В проекте используются следующие системы координат:
1. Система координат САПР
2. Система координат слайсера / рабочего стола
3. Система координат CAE

Все данные траекторий приводятся к системе координат placed STL
с учетом матриц преобразования и коэффициентов усадки,
предоставляемых слайсером.

---

### 5.1 Конвенция преобразований (экспорт Simulation Data)

Файл экспорта симуляции содержит:

- коэффициенты усадки по осям (для model/support),
- матрицу `STL to CMB transformation matrix`,
- таблицу точек/сегментов траекторий в координатах **CMB**.

В проекте эталонной системой координат считается placed STL. Поэтому при сопоставлении траекторий с геометрией:

- `XYZ` из таблицы читаются как CMB-координаты,
- применяется обратное преобразование (`CMB -> STL`) на основе матрицы `STL -> CMB` (и коэффициентов усадки, как они указаны слайсером).

Реализация должна валидировать преобразование: преобразованные точки траекторий должны попадать в габариты (или вблизи) placed STL.


## 6. CAE-представление детали (основной режим)

### 6.1 Геометрия
- Гладкое, замкнутое твердое тело,
- соответствующее placed STL,
- без явного моделирования инфилла, поддержек и подложки.

### 6.2 Сетка
- Объемная конечно-элементная сетка (tet/hex),
- плотность сетки не привязана к геометрии валиков.

---

## 7. Материальная модель

Материал детали моделируется как **трансверсально-изотропный**:

- плоскость изотропии: плоскость печати (XY),
- ось анизотропии: направление построения (Z).

Параметры материала:
- E₁ = E₂ ≠ E₃
- G₁₂, G₁₃, G₂₃
- ν₁₂, ν₁₃, ν₂₃

---

## 8. Учет внутренней структуры печати (инфилла)

Внутренняя структура заполнения, сформированная в слайсере
(процент инфилла, паттерн, ориентация дорожек),
**не восстанавливается в виде явной геометрической решетки**
в CAE-режиме.

Влияние инфилла учитывается через:
- ориентацию траекторий печати,
- локальные системы координат материала,
- эффективные анизотропные свойства элементов.

Таким образом, гладкая геометрия используется как расчетная область,
а внутренняя структура отражается в физических свойствах материала.

---

## 9. Сопоставление траекторий и конечных элементов

Каждому конечному элементу назначается локальная система координат:

- ось X — вдоль доминирующего направления траектории печати,
- ось Z — вдоль направления построения,
- ось Y — ортогональное дополнение.

Ориентация определяется на основе анализа траекторий
в соответствующем слое по координате Z.

---

## 10. Поддержки и подложка

- Поддержки и подложка (raft) идентифицируются по типу траектории
  и/или по координате Z.
- Эти элементы **исключаются** из расчетной геометрии детали.
- Их данные могут использоваться только для диагностики.

---

## 11. Геометрическое восстановление внутренней структуры (опциональный режим)

После выполнения CAE-анализа и подтверждения корректности результатов
проект предусматривает возможность восстановления
явной геометрической модели внутренней структуры детали.

Геометрическая реконструкция может выполняться в виде:
- протягивания (sweep) валиков по траекториям печати,
- воксельного восстановления с последующей генерацией твердого тела,
- гибридного подхода с гладкой внешней оболочкой и внутренним инфиллом.

Данный режим предназначен для:
- использования детали в сборках,
- оценки массы и моментов инерции,
- визуализации и архивирования.

---

### 11.1 Интеграция с nTop (nTopology) (рекомендуемый путь получения STEP)

Прямое преобразование воксельной/пористой структуры в корректное B-Rep твердое тело (STEP) часто получается тяжёлым и нестабильным.
Поэтому рекомендуемый практический workflow для получения CAD-тела с внутренними пустотами следующий:

1. Восстановить объёмное (воксельное) представление материала по траекториям `Type = 1` (только модель; `Type = 0` исключается).
2. Экспортировать объём как volumetric field, который понимает nTop (рекомендуется **OpenVDB**).
3. В nTop преобразовать поле в твердое тело (isosurface/solidification/repair) и при необходимости “почистить” геометрию.
4. Экспортировать итоговое твердое тело в **STEP** уже из nTop.

Соответственно, проект должен уметь формировать:
- `*.vdb` (основной) — объёмное поле “материал/пустота”.
- `*.stl` (опционально) — превью-сетка, полученная из объёма.
- `*.json` — метаданные (размер вокселя, пороги, исходные файлы/задание, shrink/матрица, правила фильтрации траекторий).

---

## 12. Выходные данные

Результаты работы проекта:
- CAE-пригодная геометрия (STL / STEP),
- данные ориентации материала для ANSYS,
- геометрия детали с внутренней структурой (опционально),
- диагностические и статистические отчеты.

---

## 13. Этапы реализации

### Этап 1 — Анализ данных слайсинга
- разбор форматов файлов,
- валидация координат,
- классификация траекторий.

### Этап 2 — CAE-представление
- формирование гладкой геометрии,
- задание анизотропии и ориентаций,
- экспорт в CAE.

### Этап 3 — Геометрическая реконструкция
- восстановление инфилла,
- формирование твердого тела,
- экспорт для CAD/сборок.

---

## 14. Допущения и ограничения

- пористость учитывается через эффективные свойства,
- термические остаточные напряжения не моделируются,
- материал внутри локальных областей считается однородным.

---

## 15. Возможные расширения

- межслойные когезионные модели,
- прогрессирующее разрушение,
- учет остаточных напряжений,
- многоматериальная печать.
